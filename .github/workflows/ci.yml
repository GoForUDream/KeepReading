# ============================================
# CI Pipeline - Keep Reading
# ============================================
# WHAT: Automated testing and validation on every PR
# WHY: Catch bugs before they reach dev/stag/main branches
# HOW: Runs linting, type-checking, tests, and builds

name: CI

# WHAT: When to run this workflow
# WHY: Run on every PR to dev, stag, main branches
# HOW: GitHub triggers workflow on pull_request events
on:
  pull_request:
    branches:
      - dev
      - stag
      - main

# WHAT: Limit concurrent runs
# WHY: Cancel old workflow runs when new commits are pushed
# HOW: Uses PR number as group identifier
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================
  # Backend Checks
  # ==========================================
  backend:
    name: Backend CI
    runs-on: ubuntu-latest

    steps:
      # WHAT: Checkout code
      # WHY: Need code to run checks on it
      # HOW: Uses official GitHub action
      - name: Checkout code
        uses: actions/checkout@v4

      # WHAT: Setup Node.js
      # WHY: Need Node to run npm commands
      # HOW: Uses official Node.js action
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      # WHAT: Install dependencies
      # WHY: Need packages to run checks
      # HOW: npm install from root (installs all workspaces)
      - name: Install dependencies
        run: npm install

      # WHAT: Export GraphQL schema
      # WHY: Frontend codegen needs the latest schema
      # HOW: Runs export-schema script
      - name: Export GraphQL schema
        run: npm run schema:export --workspace=backend

      # WHAT: Run ESLint
      # WHY: Catch code style issues and potential bugs
      # HOW: Runs lint script from backend package.json
      - name: Lint backend
        run: npm run lint --workspace=backend

      # WHAT: Run TypeScript type checking
      # WHY: Catch type errors before deployment
      # HOW: Runs tsc --noEmit (no output, just type checking)
      - name: Type check backend
        run: npm run type-check --workspace=backend

      # WHAT: Run tests
      # WHY: Ensure resolvers and business logic work correctly
      # HOW: Runs Vitest in run mode (not watch)
      - name: Run backend tests
        run: npm run test:run --workspace=backend

      # WHAT: Build backend
      # WHY: Ensure TypeScript compiles without errors
      # HOW: Compiles TS to JS in dist/
      - name: Build backend
        run: npm run build --workspace=backend

  # ==========================================
  # Frontend Checks
  # ==========================================
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      # WHAT: Export GraphQL schema from backend
      # WHY: Codegen needs the latest schema
      # HOW: Runs backend export-schema script
      - name: Export GraphQL schema
        run: npm run schema:export --workspace=backend

      # WHAT: Generate GraphQL types and hooks
      # WHY: Frontend needs generated types before type-checking
      # HOW: Runs graphql-codegen
      - name: Generate GraphQL types
        run: npm run codegen --workspace=frontend

      # WHAT: Run ESLint
      # WHY: Enforce React best practices and catch errors
      - name: Lint frontend
        run: npm run lint --workspace=frontend

      # WHAT: Run TypeScript type checking
      # WHY: Catch type errors in React components
      - name: Type check frontend
        run: npm run type-check --workspace=frontend

      # WHAT: Run tests
      # WHY: Ensure components render and behave correctly
      # HOW: Runs Vitest with React Testing Library
      - name: Run frontend tests
        run: npm run test:run --workspace=frontend

      # WHAT: Build frontend
      # WHY: Ensure Vite can bundle the app for production
      # HOW: Builds static files to dist/
      - name: Build frontend
        run: npm run build --workspace=frontend

  # ==========================================
  # Docker Build Check
  # ==========================================
  docker:
    name: Docker Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # WHAT: Setup Docker Buildx
      # WHY: Advanced Docker build features
      # HOW: Uses official Docker action
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # WHAT: Build Docker images
      # WHY: Ensure Dockerfiles are valid and images build
      # HOW: Uses docker compose build command
      # NOTE: Don't push images, just verify they build
      - name: Build Docker images
        run: docker compose build

  # ==========================================
  # Success Summary
  # ==========================================
  ci-success:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    needs: [backend, frontend, docker]

    steps:
      - name: All checks passed
        run: |
          echo "âœ… All CI checks passed successfully!"
          echo "âœ… Backend: Linting, Type checking, Tests, Build"
          echo "âœ… Frontend: Linting, Type checking, Tests, Build"
          echo "âœ… Docker: Image builds verified"
          echo ""
          echo "PR is ready for review! ðŸŽ‰"
